@using System.Linq
@model MangakaApp.Models.ReadChapterVM

@{
    Layout = "_Layout";
    var domainCdn = ViewData["DomainCdn"]?.ToString();
}

<style>
    /* 1. Animation mượt mà khi load trang */
    .fade-in {
        animation: fadeIn 0.5s ease-in-out;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* 2. Container chứa ảnh */
    .reading-content img {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* Đổ bóng nhẹ cho ảnh */
        background-color: #f0f2f5; /* Màu nền chờ khi ảnh chưa load */
        min-height: 200px; /* Tránh layout shift (giật khung hình) */
    }

    /* 3. Khoảng trống dưới cùng để không bị thanh menu che */
    .page-spacer {
        height: 80px;
    }

    /* 4. Thanh điều khiển cố định bên dưới (Bottom Bar) */
    .bottom-control-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: rgba(255, 255, 255, 0.95); /* Màu trắng hơi trong suốt */
        backdrop-filter: blur(10px); /* Hiệu ứng mờ đục (Glassmorphism) */
        border-top: 1px solid #e0e0e0;
        padding: 10px 15px;
        z-index: 1000;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        transition: transform 0.3s ease-in-out;
    }

    /* Ẩn thanh menu khi cuộn xuống (nếu muốn) - Ở đây tôi để luôn hiện cho tiện */

    /* 5. Nút Back to Top */
    #btn-back-to-top {
        position: fixed;
        bottom: 80px; /* Nằm trên thanh control bar */
        right: 20px;
        display: none; /* Mặc định ẩn */
        z-index: 1001;
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background-color: #0d6efd; /* Màu xanh primary */
        color: white;
        border: none;
        box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        transition: all 0.3s;
    }

        #btn-back-to-top:hover {
            background-color: #0b5ed7;
            transform: translateY(-3px); /* Nhảy nhẹ lên khi hover */
        }

    /* Responsive cho Mobile */
    @@media (max-width: 576px) {
        .bottom-control-bar {
            padding: 8px;
            gap: 5px;
        }
        /* Ẩn chữ "Chap trước/sau" trên mobile cho gọn, chỉ hiện icon */
        .btn-nav-text {
            display: none;
        }

        .chapter-select {
            max-width: 150px; /* Giới hạn chiều rộng dropdown trên mobile */
        }
    }
</style>

<div class="container mt-4 fade-in">
    <div class="mb-3">
        <a href="@Url.Action("Detail", "Home", new { slug = Model.MangaSlug })" class="btn btn-outline-secondary btn-sm border-0">
            <i class="bi bi-arrow-left"></i> Trở về trang truyện
        </a>
        <h4 class="text-center mt-2 fw-bold text-primary">Chapter: @Model.CurrentChapterName</h4>
    </div>

    <div class="reading-content text-center">
        @if (Model.CurrentChapter?.Item?.ChapterImage != null)
        {
            foreach (var img in Model.CurrentChapter.Item.ChapterImage)
            {
                <img src="@($"{domainCdn}/{Model.CurrentChapter.Item.ChapterPath}/{img.ImageFile}")"
                     class="img-fluid d-block mx-auto mb-1 rounded"
                     alt="Page @img.ImagePage"
                     loading="lazy" />
            }
        }
    </div>

    <div class="page-spacer"></div>
</div>

<button type="button" id="btn-back-to-top" onclick="scrollToTop()">
    <i class="bi bi-arrow-up"></i>
</button>

<div class="bottom-control-bar">
    @if (!string.IsNullOrEmpty(Model.PrevChapterId))
    {
        <a href="@Url.Action("ReadChapter", "Home", new { slug = Model.MangaSlug, chapterId = Model.PrevChapterId })"
           class="btn btn-outline-primary rounded-pill">
            <i class="bi bi-chevron-left"></i> <span class="btn-nav-text">Trước</span>
        </a>
    }
    else
    {
        <button class="btn btn-outline-secondary rounded-pill" disabled>
            <i class="bi bi-chevron-left"></i>
        </button>
    }

    <select class="form-select w-auto chapter-select shadow-none border-primary" onchange="window.location.href = this.value;">
        @foreach (var chap in Model.ChapterList)
        {
            var cleanId = chap.ChapterApiData.Split('/').Last();
            var isSelected = cleanId == Model.CurrentChapterId ? "selected" : "";
            var link = Url.Action("ReadChapter", "Home", new { slug = Model.MangaSlug, chapterId = cleanId });

            if (isSelected == "selected")
            {
                <option value="@link" selected>Chapter @chap.ChapterName</option>
            }
            else
            {
                <option value="@link">Chapter @chap.ChapterName</option>
            }
        }
    </select>

    @if (!string.IsNullOrEmpty(Model.NextChapterId))
    {
        <a href="@Url.Action("ReadChapter", "Home", new { slug = Model.MangaSlug, chapterId = Model.NextChapterId })"
           class="btn btn-primary rounded-pill">
            <span class="btn-nav-text">Sau</span> <i class="bi bi-chevron-right"></i>
        </a>
    }
    else
    {
        <button class="btn btn-secondary rounded-pill" disabled>
            <i class="bi bi-chevron-right"></i>
        </button>
    }
</div>

<script>
    // 1. Logic nút Back to Top
    var mybutton = document.getElementById("btn-back-to-top");

    window.onscroll = function () {
        scrollFunction();
    };

    function scrollFunction() {
        // Hiện nút khi cuộn quá 300px
        if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
            mybutton.style.display = "block";
        } else {
            mybutton.style.display = "none";
        }
    }

    function scrollToTop() {
        // Cuộn mượt lên đầu
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // 2. Logic phím tắt (Mũi tên trái/phải để chuyển chap)
    document.addEventListener('keydown', function(event) {
        if (event.key === "ArrowLeft") {
            var prevBtn = document.querySelector(".bottom-control-bar .btn-outline-primary");
            if(prevBtn) prevBtn.click();
        }
        else if (event.key === "ArrowRight") {
            var nextBtn = document.querySelector(".bottom-control-bar .btn-primary");
            if(nextBtn) nextBtn.click();
        }
    });
</script>