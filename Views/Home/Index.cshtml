@using MangakaApp.Models
@model MangakaApp.Models.MangaListData

@{
    // ViewData["Title"] = "Trang chủ";
    string imageCdnUrl = "https://otruyenapi.com/uploads/comics/";

    var pager = ViewBag.Pager as PaginationVMModel;
    string actionName = ViewData["ActionName"] as string ?? "Index";
    string currentSlug = ViewData["CurrentSlug"] as string;
    string currentKeyword = ViewData["CurrentKeyword"] as string;
}

@* --- CSS TÙY CHỈNH & ANIMATION --- *@
<style>
    /* 1. Tỷ lệ khung hình ảnh chuẩn Truyện tranh (2:3) - QUAN TRỌNG CHO RESPONSIVE */
    .manga-aspect-ratio {
        aspect-ratio: 2 / 3;
        width: 100%;
        object-fit: cover;
    }

    /* 2. Hiệu ứng Hover */
    .hover-zoom-img {
        transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    .card-hover-effect {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

        .card-hover-effect:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3) !important;
            border-color: var(--bs-primary) !important;
        }

            .card-hover-effect:hover .hover-zoom-img {
                transform: scale(1.08);
            }

    /* 3. Tiện ích text */
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    /* 4. Animation Fade In */
    @@keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-fade-in {
        opacity: 0;
        animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    /* 5. Responsive Search Bar (CSS hỗ trợ Layout) */
    .search-bar-responsive {
        width: 100%;
    }

    @@media (min-width: 992px) {
        .search-bar-responsive {
            width: 400px;
        }
        /* Trên PC thì rộng 400px */
    }

    /* 6. Tooltip Responsive */
    .notification-tooltip {
        max-width: 90vw;
    }
    /* Không tràn màn hình trên mobile */

    /* 7. Pagination Responsive */
    .pagination {
        flex-wrap: wrap;
        justify-content: center;
    }
</style>

<div class="container mt-4 mt-lg-5">

    @* --- HEADER --- *@
    <div class="text-center mb-4">
        <h2 class="text-warning fw-bold mb-2" style="text-shadow: 0 0 15px rgba(255, 193, 7, 0.4);">
            <i class="bi bi-stars me-2"></i>Sang - Xịn - Mịn
        </h2>
        <div class="d-flex align-items-center justify-content-between border-bottom border-secondary pb-2">
            <h3 class="h5 h4-md text-white mb-0 text-truncate">
                @ViewData["Title"]
            </h3>
            <span class="badge bg-primary rounded-pill px-3 py-2">
                Trang @((pager != null) ? pager.CurrentPage : 1)
            </span>
        </div>
    </div>

    @* --- DANH SÁCH TRUYỆN (GRID SYSTEM) --- *@
    @* row-cols-2: Điện thoại hiện 2 truyện/hàng
       row-cols-md-4: Tablet hiện 4 truyện/hàng
       row-cols-lg-6: PC hiện 6 truyện/hàng
    *@
    <div class="row row-cols-2 row-cols-md-4 row-cols-lg-6 g-3 g-md-4 mb-5">
        @if (Model != null && Model.Items != null)
        {
            int delayIndex = 0;
            foreach (var item in Model.Items)
            {
                string thumbUrl = item.ThumbUrl.StartsWith("http") ? item.ThumbUrl : imageCdnUrl + item.ThumbUrl;
                string latestChap = item.ChaptersLatest != null && item.ChaptersLatest.Count > 0 ? $"Chap {item.ChaptersLatest[0].ChapterName}" : "N/A";

                string updatedDate = "Đang cập nhật";
                if (!string.IsNullOrEmpty(item.UpdatedAt) && DateTime.TryParse(item.UpdatedAt, out DateTime parsedDate))
                {
                    // Trên mobile chỉ hiện ngày/tháng cho ngắn
                    updatedDate = parsedDate.ToString("dd/MM HH:mm");
                }

                delayIndex++;
                int delayTime = (delayIndex <= 12) ? delayIndex * 50 : 0;

                <div class="col">
                    <div class="card h-100 text-white border-secondary rounded-3 overflow-hidden shadow-sm card-hover-effect animate-fade-in"
                         style="background-color: #233044; animation-delay: @(delayTime)ms;">

                        @* ẢNH BÌA: Dùng class manga-aspect-ratio thay cho height cố định *@
                        <div class="overflow-hidden position-relative w-100 ratio-container">
                            <img src="@thumbUrl" class="manga-aspect-ratio hover-zoom-img"
                                 alt="@item.Name" loading="lazy">

                            @* Badge Chapter nằm đè lên ảnh (Góc trái trên) - Tiết kiệm diện tích *@
                            <span class="position-absolute top-0 start-0 badge bg-primary m-2 shadow-sm" style="font-size: 0.75rem;">
                                @latestChap
                            </span>
                        </div>

                        <div class="card-body p-2 d-flex flex-column text-center">
                            @* Tên truyện *@
                            <h6 class="card-title fw-semibold mb-1 line-clamp-2 text-decoration-none"
                                title="@item.Name" style="font-size: 0.9rem; min-height: 2.4em;">
                                @item.Name
                            </h6>

                            @* Ngày giờ - Đẩy xuống đáy *@
                            <div class="mt-auto pt-2 border-top border-secondary border-opacity-25">
                                <p class="card-text text-white-50 small mb-0 fst-italic" style="font-size: 0.75rem;">
                                    <i class="bi bi-clock me-1"></i>@updatedDate
                                </p>
                            </div>

                            <a href="/Home/Detail?slug=@item.Slug" class="stretched-link"></a>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="col-12 text-center text-white py-5 animate-fade-in">
                <i class="bi bi-search display-1 text-muted mb-3 opacity-50"></i>
                <p class="lead">Không tìm thấy truyện nào...</p>
            </div>
        }
    </div>

   <partial name="_Pagination" model='new PaginationVM { 
    Pager = pager, 
    ActionName = actionName, 
    CurrentSlug = ViewBag.CurrentSlug 
}' />
</div>